# Тестовое задание на позицию Разработчик PostgreSQL

### 1. Концептуальная и физическая модели данных 
Концептуальная и физическая модели данных представлены в виде Entity-Relation диаграммы и, непосредственно, реализации данной архитектуры в DDL, описанном в файле `init.sql`. 

<div>
    <img src="https://github.com/Jardinesdelareina/postgresql_developer_test/blob/main/erd.png" width="1000" height="700"/>&nbsp;
</div>

<b>Отделы (departments)</b>

|Key|Column|Type|Unique|Nullable|Description|
|---|---|---|---|---|---|
|PK|id|INT|*|*|Автоинкрементный идентификатор|
||title|VARCHAR(200)||*|Название отдела|


<b>Офисы (offices)</b>

|Key|Column|Type|Unique|Nullable|Description|
|---|---|---|---|---|---|
|PK|id|INT|*|*|Автоинкрементный идентификатор|
||number|INT||*|Номер офиса|
||seats|INT||*|Количество свободных мест в офисе|

<em>Ограничения целостности:</em>

* Количество свободных мест не может быть меньше нуля:
`CHECK (seats >= 0)`



<b>Должности (roles)</b>

|Key|Column|Type|Unique|Nullable|Description|
|---|---|---|---|---|---|
|PK|id|INT|*|*|Автоинкрементный идентификатор|
||title|VARCHAR(300)||*|Название должности|
||salary|NUMERIC(10, 2)||*|Размер зарплаты на должности по-умолчанию|


<b>Сотрудники (employees)</b>

|Key|Column|Type|Unique|Nullable|Description|
|---|---|---|---|---|---|
|PK|id|INT|*|*|Автоинкрементный идентификатор|
||first_name|VARCHAR(50)||*|Имя|
||last_name|VARCHAR(50)||*|Фамилия|
||middle_name|VARCHAR(50)|||Отчество|
||date_of_birdth|DATE||*|Дата рождения|
||salary|NUMERIC(10, 2)|||Зарплата|
|FK (employees.id)|fk_boss|INT|||Прямой начальник сотрудника|
|FK (departments.id)|fk_department|INT|||Отдел, в котором числится сотрудник|
|FK (offices.id)|fk_office|INT|||Офис, к которому прикрепен сотрудник|
|FK (roles.id)|fk_role|INT|||Должность|

<em>Ограничения целостности:</em>

* При удалении начальника и офиса сотрудника стирается информация о связи:
`ON DELETE SET NULL`

* При удалении отдела и должности происходит каскадное удаление сотрудников, имеющие соответствующие внешние ключи к удаленным объектам:
`ON DELETE CASCADE`


### 2. Бизнес-процесс в нотации BPMN 2.0

<div>
    <img src="https://github.com/Jardinesdelareina/postgresql_developer_test/blob/main/bpmn.png" width="1000" height="700"/>&nbsp;
</div>


### 3. Реализация модели данных

Файл `init.sql` содержит скрипт инициализации базы данных <b>company</b>, реализацию "API" и генерацию тестовых данных для проверки на корректную работу объектов.

База данных разделена на три схемы:
* `core` содержит DDL, описывающий таблицы.
* `api` состоит из хранимых процедур и представлений, являющихся тем самым API для доступа к данным - добавление/изменение/удаление данных и вывод подробной информации о сущностях.
* `service` - служебная схема, в которой хранятся триггеры и функции, обеспечивающие функционирование бизнес-логики на стороне базы данных.


### 4. API

"API" базы данных содержится в схеме `api`. Объекты данной схемы реализуют стандартный CRUD. 

Привилегии публичного доступа к схеме `api` реализуются с помощью следующего блока кода:
```sql 
GRANT USAGE ON SCHEMA api TO PUBLIC;
GRANT EXECUTE ON ALL PROCEDURES IN SCHEMA api TO PUBLIC;
GRANT SELECT ON ALL TABLES IN SCHEMA api TO PUBLIC;
```

Расширенный функционал обеспечивают триггеры, которые следят за соблюдением целостности данных, и в случае необходимости вносят изменения в данные.

|Триггер|Описание задачи|
|---|---|
|trg_default_salary|Если у сотрудника не выставлена зарплата, то триггер подставляет в employees.salary значение, указанное для должности сотрудника по-умолчанию|
|trg_decrement_seats|Когда новый сотрудник прикрепляется к какому-то офису, он занимает в нем место. Данный триггер следит за корректным уменьшением количества свободных мест в таблице offices.|
|trg_increment_seats|Когда сотрудник удаляется, он освобождает место в офисе. Триггер увеичивает количество мест на 1 при каждом удалении сотрудника из офиса|


### 5. Генерация данных

Функционал генерирования данных представлен функциями, представлениями и даже рядом простых выховов процедур из API. 
Данные об отделах, офисах и сотрудниках генерируются с помощью анонимных функций PL/pgSQL. 
Данные о должностях сгенерированы простыми вызовами хранимых процедур из схемы `api`.

<em>Объем тестовых данных можно регулировать в циклах FOR анонимных функций.</em>


### 6. Скрипты на выборку

Все скрипты на выборку данных из API предоставлены в файле `scripts.sql`.


### Простые выборки

Простые выборки подготовлены в файле `simple_samples.sql`.